import openai
import os
import requests

from data_layer.storage import upload_blob
from dotenv import load_dotenv, find_dotenv
_ = load_dotenv(find_dotenv())

openai.api_key  = os.getenv('OPENAI_API_KEY')
script_dir = os.path.dirname(os.path.abspath(__file__))
static_folder = os.path.join(script_dir, '../static')


context = f"""
            You are an illustrator \n
            Based on the story title your task is to create an illustration (take into account that the story is targeted to children): \n\n
        """

'''Returns illustration generated by OpenAI DALL-E.'''
def generate_illustration(story_id, story_title):
    prompt = f'''
            {context}
            {story_title}
        '''
    
    # Limit the prompt to 1000 tokens
    prompt = prompt[:1000]

    response = openai.Image.create(
        prompt=prompt,
        n=1,
        size="512x512",
    )

    image_url = response['data'][0]['url']
    
    # Get image file from the URL
    image_file = requests.get(image_url).content

    # Save the image file to the static folder
    image_name = f"story-{story_id}.jpg"
    image_path = f"{static_folder}/{image_name}"
    with open(image_path, "wb") as f:
        f.write(image_file)

    upload_blob(image_path, image_name)

    return image_path